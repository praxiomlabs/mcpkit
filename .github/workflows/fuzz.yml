name: Fuzzing

on:
  # Run nightly at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzzing duration in seconds per target'
        required: false
        default: '300'
      target:
        description: 'Specific fuzz target (empty for all)'
        required: false
        default: ''
  # Run on PRs that modify fuzz targets
  pull_request:
    paths:
      - 'fuzz/**'
      - 'crates/mcp-core/src/protocol/**'
      - 'crates/mcp-core/src/types/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - fuzz_jsonrpc_message
          - fuzz_jsonrpc_request
          - fuzz_jsonrpc_response
          - fuzz_progress_token
          - fuzz_jsonrpc_structured
          - fuzz_protocol_version
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fuzz -> target

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Skip if specific target requested
        if: ${{ github.event.inputs.target != '' && github.event.inputs.target != matrix.target }}
        run: echo "Skipping ${{ matrix.target }} - specific target requested"

      - name: Restore fuzz corpus
        uses: actions/cache/restore@v4
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: fuzz-corpus-${{ matrix.target }}-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-${{ matrix.target }}-

      - name: Run fuzzer
        if: ${{ github.event.inputs.target == '' || github.event.inputs.target == matrix.target }}
        working-directory: fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || '300' }}"
          echo "Running ${{ matrix.target }} for ${DURATION}s"
          cargo +nightly fuzz run ${{ matrix.target }} -- \
            -max_total_time=${DURATION} \
            -print_final_stats=1
        continue-on-error: true

      - name: Save fuzz corpus
        uses: actions/cache/save@v4
        if: always()
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: fuzz-corpus-${{ matrix.target }}-${{ github.sha }}

      - name: Upload crash artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: crash-${{ matrix.target }}
          path: |
            fuzz/artifacts/${{ matrix.target }}/**
          retention-days: 30

  fuzz-coverage:
    name: Fuzz Coverage Report
    runs-on: ubuntu-latest
    needs: fuzz
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fuzz -> target

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Restore all corpus caches
        run: |
          for target in fuzz_jsonrpc_message fuzz_jsonrpc_request fuzz_jsonrpc_response fuzz_progress_token fuzz_jsonrpc_structured fuzz_protocol_version; do
            echo "Restoring corpus for $target"
          done

      - name: Generate coverage report
        working-directory: fuzz
        run: |
          echo "# Fuzzing Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          for target in fuzz_jsonrpc_message fuzz_jsonrpc_request fuzz_jsonrpc_response fuzz_progress_token fuzz_jsonrpc_structured fuzz_protocol_version; do
            if [ -d "corpus/$target" ]; then
              count=$(find corpus/$target -type f 2>/dev/null | wc -l)
              echo "| $target | ${count} corpus entries |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $target | No corpus |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  notify-on-crash:
    name: Notify on Crash
    runs-on: ubuntu-latest
    needs: fuzz
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue on crash
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner,
              repo,
              title: 'ðŸ”´ Fuzzing found a crash',
              body: `## Fuzzing Crash Detected

            The nightly fuzzing run found one or more crashes.

            **Run:** ${runUrl}

            Please investigate the crash artifacts and fix any issues found.

            ### Next Steps
            1. Download the crash artifacts from the failed workflow run
            2. Reproduce the crash locally with \`cargo +nightly fuzz run <target> -- <artifact>\`
            3. Fix the issue and add a regression test
            `,
              labels: ['bug', 'security', 'fuzzing']
            });
